import numpy as np
import matplotlib.pyplot as plt
from scipy.fft import fft, fftfreq

# 生成一个示例信号 (例如，正弦波叠加)
t = np.linspace(0, 1, 1000, False)  # 1 秒，1000 个采样点
sig = np.sin(2*np.pi*12*t) + 0.75*np.sin(2*np.pi*14*t) # 10Hz 和 20Hz 正弦波叠加
sig2 = - np.sin(2*np.pi*12*t) + 0.75*np.sin(2*np.pi*14*t) # 10Hz 和 20Hz 正弦波叠加
sig_nonlinear1 = sig**2
sig_nonlinear2 = 1 / (1 + np.exp(-sig2))
sig_nonlinear = sig_nonlinear1 * sig_nonlinear2

# 进行傅里叶变换
yf = fft(sig_nonlinear)
xf = fftfreq(len(sig), 1/1000) # 采样率仍然为1000Hz

# 只取正频率部分
positive_frequencies = xf[:len(xf)//2]
positive_amplitudes = np.abs(yf[:len(yf)//2])

# 指定要查找谐波的基频
fundamental_frequency = 28  # 例如，查找 10 Hz 的谐波

# 查找基频在频谱中的索引 (找到最接近的频率)
index_fundamental = np.argmin(np.abs(positive_frequencies - fundamental_frequency))

# 计算谐波频率
harmonics_frequencies = [fundamental_frequency * i for i in range(1, 6)] # 计算前5个谐波

# 查找谐波频率在频谱中的幅度
harmonics_amplitudes = []
for freq in harmonics_frequencies:
    index_harmonic = np.argmin(np.abs(positive_frequencies - freq))
    amplitude = positive_amplitudes[index_harmonic]
    harmonics_amplitudes.append(amplitude)

# 打印结果
print(f"基频: {fundamental_frequency} Hz")
for i, (freq, amp) in enumerate(zip(harmonics_frequencies, harmonics_amplitudes)):
    print(f"第 {i+1} 次谐波 ({freq} Hz): 幅度 = {amp:.2f}")


# 绘制频谱图，并标记基频和谐波
plt.plot(positive_frequencies, positive_amplitudes)
plt.xlabel('Frequency (Hz)')
plt.ylabel('Magnitude')
plt.title('Frequency Spectrum with Harmonics Marked')
plt.stem(harmonics_frequencies, harmonics_amplitudes, linefmt='r-', markerfmt='ro', basefmt='r-') #标记谐波
plt.stem(fundamental_frequency, positive_amplitudes[index_fundamental], linefmt='g-', markerfmt='go', basefmt='g-') #标记基频
plt.grid(True)
plt.show()